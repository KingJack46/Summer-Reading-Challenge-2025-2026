<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library Reading Challenge</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #ccc;
    }
    .section {
      margin: 20px 0;
      background: #fff;
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
    .leaderboard-bar {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .leaderboard-profile {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #007bff;
      color: #fff;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    .leaderboard-label {
      font-weight: 600;
      margin-left: 10px;
    }

    /* Progress Bar */
    .progress-container {
      position: relative;
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 15px;
      overflow: visible;
      margin-top: 15px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #00bfff);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 15px 0 0 15px;
    }
    .milestone {
      position: absolute;
      top: -8px;
      width: 2px;
      height: 46px;
      background: #555;
      z-index: 2;
    }
    .milestone-label {
      position: absolute;
      bottom: 100%;
      margin-bottom: 8px;
      font-size: clamp(9px, 1.2vw, 11px);
      transform: translateX(-50%);
      color: #333;
      font-weight: 500;
      white-space: nowrap;
      z-index: 3;
    }
    .progress-text {
      margin-top: 10px;
      font-weight: bold;
    }
    input, button {
      margin-right: 10px;
    }
    button {
      cursor: pointer;
    }
    .submit-minutes {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
    }
    .submit-minutes:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

  <header>
    <h1>Library Reading Challenge</h1>
    <div id="profileIcon" class="profile">U</div>
  </header>

  <main>
    <section id="welcomeSection" class="section">
      <h2 id="welcomeMessage">Welcome back!</h2>
    </section>

    <section id="leaderboardSection" class="section">
      <h3>Top 10 Leaderboard</h3>
      <div id="leaderboardContainer"></div>
    </section>

    <section id="communitySection" class="section">
      <h3>Community Progress</h3>
      <div id="communityProgressBar" class="progress-container">
        <div id="progressFill" class="progress-bar"></div>
      </div>
      <div id="progressText" class="progress-text"></div>
    </section>

    <section id="userMinutesSection" class="section">
      <h3>Your Logged Minutes</h3>
      <p id="userMinutes">0 minutes</p>
    </section>

    <section id="logMinutesSection" class="section">
      <h3>Log Reading Time</h3>
      <input id="bookTitleInput" type="text" placeholder="Book Title">
      <input id="minutesInput" type="number" placeholder="Minutes" min="1" max="120">
      <button id="logMinutesBtn" class="submit-minutes">Log Minutes</button>
      <p id="logMessage" style="color: red;"></p>
    </section>
  </main>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = 'https://hfugnpqguidgosxyuioj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const COMMUNITY_GOAL = 1_000_000;

    let currentUser = null;

    /* ========= DATA FETCH FUNCTIONS ========= */
    async function getUserData(username) {
      const { data, error } = await supabase
        .from('Userdetails')
        .select('*')
        .eq('user_name', username)
        .single();
      if (error) throw error;
      return data;
    }

    async function getUserLogs(username) {
      const { data, error } = await supabase
        .from('loghistory')
        .select('minutes_logged')
        .eq('user_name', username);
      if (error) throw error;
      return data;
    }

    async function getAllUsers() {
      const { data, error } = await supabase
        .from('Userdetails')
        .select('user_name, minutes_logged');
      if (error) throw error;
      return data;
    }

    async function getAllLogs() {
      const { data, error } = await supabase.from('loghistory').select('minutes_logged');
      if (error) throw error;
      return data;
    }

    /* ========= RENDER FUNCTIONS ========= */
    function renderWelcome(user) {
      document.getElementById('profileIcon').textContent = user.user_name[0].toUpperCase();
      document.getElementById('welcomeMessage').textContent = `Welcome back, ${user.user_name}!`;
    }

    function renderUserMinutes(total) {
      document.getElementById('userMinutes').textContent = `${total.toLocaleString()} minutes`;
    }

    function renderLeaderboard(users) {
      const container = document.getElementById('leaderboardContainer');
      container.innerHTML = '';
      if (!users.length) {
        container.textContent = 'No leaderboard data available.';
        return;
      }
      users
        .sort((a, b) => b.minutes_logged - a.minutes_logged)
        .slice(0, 10)
        .forEach(user => {
          const bar = document.createElement('div');
          bar.classList.add('leaderboard-bar');
          bar.innerHTML = `
            <div class="leaderboard-profile">${user.user_name[0].toUpperCase()}</div>
            <div style="background:#007bff;width:${Math.min(user.minutes_logged / 10,300)}px;height:30px;border-radius:4px;"></div>
            <div class="leaderboard-label">${user.user_name}: ${user.minutes_logged} min</div>
          `;
          container.appendChild(bar);
        });
    }

    function renderProgressBar(total) {
      const fill = document.getElementById('progressFill');
      const text = document.getElementById('progressText');
      const container = document.getElementById('communityProgressBar');
      const percent = Math.min((total / COMMUNITY_GOAL) * 100, 100);
      fill.style.width = `${percent}%`;
      text.textContent = `Community has logged ${total.toLocaleString()} of ${COMMUNITY_GOAL.toLocaleString()} minutes (${percent.toFixed(2)}%)`;

      // clear old milestones
      container.querySelectorAll('.milestone, .milestone-label').forEach(el => el.remove());

      const milestones = [10000, 50000, 100000];
      for (let i = 200000; i <= COMMUNITY_GOAL; i += 100000) milestones.push(i);
      milestones.forEach(ms => {
        const pos = (ms / COMMUNITY_GOAL) * container.offsetWidth;
        const line = document.createElement('div');
        line.className = 'milestone';
        line.style.left = `${pos}px`;

        const label = document.createElement('div');
        label.className = 'milestone-label';
        label.textContent = ms >= 1_000_000 ? '1M' : (ms >= 1000 ? (ms / 1000) + 'k' : ms);
        label.style.left = `${pos}px`;

        container.append(line, label);
      });
    }

    /* ========= LOGGING ========= */
    async function logReadingMinutes(user, minutes, bookTitle) {
      const { error } = await supabase.from('loghistory').insert([
        {
          user_name: user.user_name,
          minutes_logged: minutes,
          book_title: bookTitle,
          time_logged: new Date().toISOString(),
        },
      ]);
      if (error) throw error;
    }

    /* ========= MAIN DASHBOARD LOGIC ========= */
    async function loadDashboard() {
      const username = sessionStorage.getItem('username');
      if (!username) return (window.location.href = 'login.html');

      currentUser = await getUserData(username);
      renderWelcome(currentUser);

      const userLogs = await getUserLogs(username);
      const totalUserMinutes = userLogs.reduce((s, e) => s + e.minutes_logged, 0);
      renderUserMinutes(totalUserMinutes);

      await supabase
        .from('Userdetails')
        .update({ minutes_logged: totalUserMinutes })
        .eq('user_name', username);

      const allUsers = await getAllUsers();
      renderLeaderboard(allUsers);

      const allLogs = await getAllLogs();
      const totalCommunityMinutes = allLogs.reduce((s, e) => s + e.minutes_logged, 0);
      renderProgressBar(totalCommunityMinutes);
    }

    /* ========= EVENT HANDLERS ========= */
    document.getElementById('logMinutesBtn').addEventListener('click', async () => {
      const minutes = parseInt(document.getElementById('minutesInput').value);
      const title = document.getElementById('bookTitleInput').value.trim();
      const msg = document.getElementById('logMessage');
      msg.textContent = '';
      if (!title) return (msg.textContent = 'Please enter a book title.');
      if (isNaN(minutes) || minutes < 1 || minutes > 120)
        return (msg.textContent = 'Enter a valid number of minutes (1â€“120).');

      try {
        await logReadingMinutes(currentUser, minutes, title);
        document.getElementById('minutesInput').value = '';
        document.getElementById('bookTitleInput').value = '';
        await loadDashboard();
      } catch (err) {
        msg.textContent = 'Error logging minutes: ' + err.message;
      }
    });

    window.addEventListener('resize', async () => {
      const allLogs = await getAllLogs();
      const total = allLogs.reduce((s, e) => s + e.minutes_logged, 0);
      renderProgressBar(total);
    });

    /* ========= INIT ========= */
    loadDashboard();
  </script>
</body>
</html>
