<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Library Reading Challenge</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #ccc;
    }

    .profile {
      position: relative;
      width: 40px;
      height: 40px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      z-index: 10;
    }

    .dropdown button {
      width: 100%;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      text-align: left;
    }

    .dropdown button:hover {
      background-color: #f0f0f0;
    }

    .section {
      margin: 20px 0;
      background: #fff;
      border-radius: 6px;
      padding: 20px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    /* Leaderboard */
    .leaderboard-bar {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .leaderboard-profile {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #007bff;
      color: #fff;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }

    .leaderboard-label {
      font-weight: 600;
      margin-left: 10px;
    }

    /* Progress Bar */
    .progress-container {
      position: relative;
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 15px;
      overflow: visible;
      margin-top: 15px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #00bfff);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 15px 0 0 15px;
    }

    .milestone {
      position: absolute;
      top: -8px;
      width: 2px;
      height: 46px;
      background: #555;
      z-index: 2;
    }

    .milestone-label {
      position: absolute;
      bottom: 100%;
      margin-bottom: 8px;
      font-size: clamp(9px, 1.2vw, 11px);
      transform: translateX(-50%);
      color: #333;
      font-weight: 500;
      white-space: nowrap;
      z-index: 3;
    }

    .progress-text {
      margin-top: 10px;
      font-weight: bold;
    }

    /* Inputs + Buttons */
    input, button {
      margin-right: 10px;
    }

    button {
      cursor: pointer;
    }

    .submit-minutes {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .submit-minutes:hover {
      background-color: #218838;
    }
    #bingoBoard {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  max-width: 90vw;       /* fills screen on mobile */
  width: 60%;            /* 60% on larger screens */
  margin: 0 auto;        /* center horizontally */
}

#bingoBoard div {
  padding-top: 100%;     /* makes square aspect ratio */
  position: relative;
  border: 2px solid #555;
  border-radius: 10px;
  background-color: #f0f0f0;
  text-align: center;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s, transform 0.2s;
}

#bingoBoard div.completed {
  background-color: #28a745;
  color: white;
}

#bingoBoard div span {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 5px;
}

/* Confetti container */
#confettiCanvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
}

  </style>
</head>
<body>
  <header>
    <h1>Library Reading Challenge</h1>
    <div id="profileIcon" class="profile">
      <span id="profileInitial">U</span>
      <div id="profileDropdown" class="dropdown">
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <section id="welcomeSection" class="section">
      <h2 id="welcomeMessage">Welcome back!</h2>
    </section>

    <section id="readingStreakSection" class="section">
      <h3>Your Reading Streak</h3>
      <p id="readingStreakDisplay">Loading...</p>
      <p id="dailyHighScoreDisplay">Loading...</p>
    </section>


    <section id="leaderboardSection" class="section">
      <h3>Top 10 Leaderboard</h3>
      <div id="leaderboardContainer"></div>
    </section>

    <section id="communitySection" class="section">
      <h3>Community Progress</h3>
      <div id="communityProgressBar" class="progress-container">
        <div id="progressFill" class="progress-bar"></div>
      </div>
      <div id="progressText" class="progress-text"></div>
    </section>

    <section id="userMinutesSection" class="section">
      <h3>Your Logged Minutes</h3>
      <p id="userMinutes">0 minutes</p>
    </section>

    <section id="logMinutesSection" class="section">
      <h3>Log Reading Time</h3>
      <input id="bookTitleInput" type="text" placeholder="Book Title" />
      <input id="minutesInput" type="number" placeholder="Minutes" min="1" max="120" />
      <button id="logMinutesBtn" class="submit-minutes">Log Minutes</button>
      <p id="logMessage" style="color:red;"></p>

      <p id="stopwatchDisplay" style="font-weight:bold;">⏱ 00:00</p>
      <button id="stopwatchBtn" style="background:#007bff;color:white;border:none;padding:8px 12px;border-radius:4px;">
        Start Stopwatch
      </button>
    </section>

    <section id="bingoSection" class="section">

  <h3>Summer Reading Bingo</h3>
  <p>Get 5 in a row to get bingo or fill the page!</p>

  <div id="bingoBoard"></div>
</section>
<canvas id="confettiCanvas"></canvas>


  </main>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/* -------------------------------------------------------
   INITIALIZE SUPABASE
------------------------------------------------------- */
const SUPABASE_URL = "https://hfugnpqguidgosxyuioj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmdWducHFndWlkZ29zeHl1aW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NjE3ODAsImV4cCI6MjA3ODAzNzc4MH0.eawP-KaZTXOAE_OSYeJR6Ds_c6aKsqOsXo_EGifgtrU";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;        // Auth user
let currentProfile = null;     // Userdetails record
let stopwatchInterval = null;
let stopwatchSeconds = 0;

/* -------------------------------------------------------
   AUTH + PROFILE LOADING
------------------------------------------------------- */
async function loadDashboard() {
  // 1. Check logged-in user
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  currentUser = user;

  // 2. Load the user's profile row
  const { data: profile, error } = await supabase
    .from("Userdetails")
    .select("*")
    .eq("id", user.id)
    .single();

  if (error || !profile) {
    console.error("Userdetails missing:", error);
    alert("User profile missing. Contact admin.");
    return;
  }

  currentProfile = profile;

  // 3. Update last_login
  await supabase
    .from("Userdetails")
    .update({ last_login: new Date().toISOString() })
    .eq("id", user.id);

  // 4. Initialize UI
  document.getElementById("usernameDisplay").textContent = profile.user_name;
  updateMinutesDisplay(profile.minutes_logged);
  updateStreakDisplay(profile.reading_streak);

  loadLogHistory();
  loadLeaderboard();
  loadCommunityTotals();
  loadBingoBoard();
}

/* -------------------------------------------------------
   STREAK HANDLING
------------------------------------------------------- */
async function updateReadingStreak() {
  const today = new Date().toISOString().split("T")[0];

  const { data: history } = await supabase
    .from("loghistory")
    .select("created_at")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending: false })
    .limit(1);

  let streak = currentProfile.reading_streak || 0;

  if (!history || history.length === 0) {
    streak = 1;
  } else {
    const lastLogDate = history[0].created_at.split("T")[0];
    const diff =
      (new Date(today) - new Date(lastLogDate)) / 1000 / 60 / 60 / 24;

    if (diff === 1) streak += 1;
    else if (diff > 1) streak = 1;
  }

  // Save streak
  await supabase.from("Userdetails")
    .update({ reading_streak: streak })
    .eq("id", currentUser.id);

  currentProfile.reading_streak = streak;
  updateStreakDisplay(streak);
}

/* -------------------------------------------------------
   MINUTES HANDLING
------------------------------------------------------- */
async function addMinutes(amount) {
  const newTotal = (currentProfile.minutes_logged || 0) + amount;

  await supabase.from("Userdetails")
    .update({ minutes_logged: newTotal })
    .eq("id", currentUser.id);

  currentProfile.minutes_logged = newTotal;
  updateMinutesDisplay(newTotal);

  // Add to loghistory
  await supabase.from("loghistory").insert([{
    user_id: currentUser.id,
    minutes: amount
  }]);

  loadLogHistory();
  loadLeaderboard();
  loadCommunityTotals();
  updateReadingStreak();
}

function updateMinutesDisplay(minutes) {
  document.getElementById("minutesDisplay").textContent = minutes;
}

function updateStreakDisplay(streak) {
  document.getElementById("streakDisplay").textContent = streak;
}

/* -------------------------------------------------------
   STOPWATCH FEATURE
------------------------------------------------------- */
function startStopwatch() {
  if (stopwatchInterval) return;

  stopwatchInterval = setInterval(() => {
    stopwatchSeconds++;
    document.getElementById("stopwatchDisplay").textContent =
      formatTime(stopwatchSeconds);
  }, 1000);
}

function stopStopwatch() {
  clearInterval(stopwatchInterval);
  stopwatchInterval = null;
}

async function saveStopwatch() {
  if (stopwatchSeconds === 0) return;

  await addMinutes(Math.floor(stopwatchSeconds / 60));

  stopwatchSeconds = 0;
  document.getElementById("stopwatchDisplay").textContent = "00:00:00";
}

function formatTime(sec) {
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

/* -------------------------------------------------------
   LOG HISTORY
------------------------------------------------------- */
async function loadLogHistory() {
  const { data } = await supabase
    .from("loghistory")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("created_at", { ascending: false });

  const logContainer = document.getElementById("logHistory");
  logContainer.innerHTML = data
    .map(r => `<li>${r.minutes} min — ${new Date(r.created_at).toLocaleString()}</li>`)
    .join("");
}

/* -------------------------------------------------------
   LEADERBOARD
------------------------------------------------------- */
async function loadLeaderboard() {
  const { data } = await supabase
    .from("Userdetails")
    .select("user_name, minutes_logged")
    .order("minutes_logged", { ascending: false });

  const list = document.getElementById("leaderboard");
  list.innerHTML = data
    .map(u => `<li>${u.user_name}: ${u.minutes_logged} min</li>`)
    .join("");
}

/* -------------------------------------------------------
   COMMUNITY TOTALS
------------------------------------------------------- */
async function loadCommunityTotals() {
  const { data } = await supabase.rpc("community_total_minutes");

  document.getElementById("communityTotal").textContent =
    data?.total ?? 0;
}

/* -------------------------------------------------------
   BINGO BOARD (existing system)
------------------------------------------------------- */
async function loadBingoBoard() {
  const { data } = await supabase
    .from("bingoboard")
    .select("*")
    .eq("user_id", currentUser.id);

  const board = document.getElementById("bingoBoard");
  board.innerHTML = data
    .map(cell => `
      <div class="cell ${cell.completed ? "done" : ""}">
        ${cell.label}
      </div>
    `)
    .join("");
}

/* -------------------------------------------------------
   LOGOUT
------------------------------------------------------- */
async function logout() {
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

/* -------------------------------------------------------
   START DASHBOARD
------------------------------------------------------- */
loadDashboard();
</script>

</body>
</html>














