<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Library Reading Challenge</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 20px;
      background-color: #f5f5f5;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #ccc;
    }

    .profile {
      position: relative;
      width: 40px;
      height: 40px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      z-index: 10;
    }

    .dropdown button {
      width: 100%;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      text-align: left;
    }

    .dropdown button:hover {
      background-color: #f0f0f0;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .leaderboard-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .leaderboard-bar span {
      display: inline-block;
      height: 30px;
      line-height: 30px;
      color: white;
      padding-left: 10px;
      border-radius: 4px;
    }

    .leaderboard-profile {
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      font-weight: bold;
      color: white;
      border-radius: 50%;
      background-color: #007bff;
      flex-shrink: 0;
    }

    .leaderboard-label {
      margin-left: 10px;
      font-weight: bold;
    }

    input[type="number"] {
      width: 80px;
      margin-right: 10px;
    }

    button.submit-minutes {
      background-color: #28a745;
      color: white;
    }

    button.submit-minutes:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

<header>
  <h1>Library Reading Challenge</h1>
  <div class="profile" id="profileIcon">
  <span id="profileInitial">U</span>
  <div class="dropdown" id="profileDropdown">
    <button id="logoutBtn">Logout</button>
  </div>
</div>
</header>

<div class="section" id="welcomeSection">
  <h2 id="welcomeMessage">Welcome back!</h2>
</div>

<div class="section" id="leaderboardSection">
  <h3>Top 10 Leaderboard</h3>
  <div id="leaderboardContainer"></div>
</div>

<div class="section" id="communitySection">
  <h3>Community Progress</h3>
  <p id="communityProgress"></p>
</div>

<div class="section" id="userMinutesSection">
  <h3>Your Logged Minutes</h3>
  <p id="userMinutes"></p>
</div>

<div class="section" id="logMinutesSection">
  <h3>Log More Minutes</h3>
  <input type="number" id="minutesInput" placeholder="Minutes" min="1" max="120">
  <button class="submit-minutes" id="logMinutesBtn">Log Minutes</button>
  <p id="logMessage" style="color:red;"></p>
</div>

<script>
  // üö® Supabase config
  const SUPABASE_URL = 'https://hfugnpqguidgosxyuioj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmdWducHFndWlkZ29zeHl1aW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NjE3ODAsImV4cCI6MjA3ODAzNzc4MH0.eawP-KaZTXOAE_OSYeJR6Ds_c6aKsqOsXo_EGifgtrU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const COMMUNITY_GOAL = 1000000;
  let currentUser = null;
  let userTotalMinutes = 0;

  async function loadDashboard() {
    const username = sessionStorage.getItem('username');
    if (!username) {
      window.location.href = 'login.html';
      return;
    }

    // Fetch user info
    const { data: userData, error: userError } = await supabase
      .from('Userdetails')
      .select('*')
      .eq('user_name', username)
      .single();

    if (userError) {
      alert('Error loading user data: ' + userError.message);
      return;
    }

    currentUser = userData;

    // Fetch total minutes for this user from loghistory
    const { data: logs, error: logError } = await supabase
      .from('loghistory')
      .select('minutes_logged')
      .eq('id', currentUser.user_name);

    if (logError) {
      console.error('Error fetching logs:', logError);
      return;
    }

    userTotalMinutes = logs?.reduce((sum, entry) => sum + entry.minutes_logged, 0) || 0;

    // Update UI
    document.getElementById('profileInitial').textContent = currentUser.user_name[0].toUpperCase();
    document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.user_name}!`;
    document.getElementById('userMinutes').textContent = `${userTotalMinutes} minutes`;

    // Leaderboard ‚Äî based on total logged minutes
    const { data: leaderboardData } = await supabase.rpc('get_leaderboard'); 
    // (‚ö†Ô∏è optional: see below to create this function if needed)

    const container = document.getElementById('leaderboardContainer');
    container.innerHTML = '';

    if (leaderboardData) {
      leaderboardData.forEach(user => {
        const barLength = Math.min(user.total_minutes / 10, 300);

        const barWrapper = document.createElement('div');
        barWrapper.classList.add('leaderboard-bar');

        const profileDiv = document.createElement('div');
        profileDiv.classList.add('leaderboard-profile');
        profileDiv.textContent = user.user_name[0].toUpperCase();

        const barSpan = document.createElement('span');
        barSpan.style.width = barLength + 'px';
        barSpan.style.backgroundColor = '#007bff';

        const minutesLabel = document.createElement('div');
        minutesLabel.classList.add('leaderboard-label');
        minutesLabel.textContent = user.total_minutes;

        barWrapper.appendChild(profileDiv);
        barWrapper.appendChild(barSpan);
        barWrapper.appendChild(minutesLabel);
        container.appendChild(barWrapper);
      });
    } else {
      container.textContent = 'No leaderboard data available.';
    }

    // Community total (sum of all loghistory)
    const { data: allLogs } = await supabase.from('loghistory').select('minutes_logged');
    const totalMinutes = allLogs?.reduce((sum, l) => sum + l.minutes_logged, 0) || 0;
    document.getElementById('communityProgress').textContent =
      `Community has logged ${totalMinutes} of ${COMMUNITY_GOAL} minutes (${((totalMinutes / COMMUNITY_GOAL) * 100).toFixed(2)}%)`;
  }

  // Profile dropdown toggle
  const profileIcon = document.getElementById('profileIcon');
  const dropdown = document.getElementById('profileDropdown');
  profileIcon.addEventListener('click', () => {
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  });
  document.addEventListener('click', (e) => {
    if (!profileIcon.contains(e.target)) dropdown.style.display = 'none';
  });
  document.getElementById('logoutBtn').addEventListener('click', () => {
    sessionStorage.removeItem('username');
    window.location.href = 'login.html';
  });

  // üìù Function to log minutes into loghistory
  async function logMinutesToHistory(minutes, bookTitle = null) {
    const { error } = await supabase
      .from('loghistory')
      .insert([{ id: currentUser.user_name, minutes_logged: minutes, book_title: bookTitle }]);

    if (error) {
      console.error('Error logging minutes:', error);
      alert('Error logging minutes: ' + error.message);
    } else {
      await loadDashboard();
    }
  }

  // Manual entry
  document.getElementById('logMinutesBtn').addEventListener('click', async () => {
    const minutes = parseInt(document.getElementById('minutesInput').value);
    const msg = document.getElementById('logMessage');
    msg.textContent = '';

    if (isNaN(minutes) || minutes < 1 || minutes > 120) {
      msg.textContent = 'Please enter a valid number of minutes (1-120).';
      return;
    }

    await logMinutesToHistory(minutes);
    document.getElementById('minutesInput').value = '';
  });

  // üïí Stopwatch feature
  let stopwatchInterval = null;
  let startTime = null;

  const logSection = document.getElementById('logMinutesSection');
  const stopwatchDisplay = document.createElement('p');
  stopwatchDisplay.id = 'stopwatchDisplay';
  stopwatchDisplay.style.fontWeight = 'bold';
  stopwatchDisplay.textContent = '‚è± 00:00';

  const stopwatchBtn = document.createElement('button');
  stopwatchBtn.textContent = 'Start Stopwatch';
  stopwatchBtn.style.marginLeft = '10px';
  stopwatchBtn.style.backgroundColor = '#007bff';
  stopwatchBtn.style.color = 'white';
  stopwatchBtn.style.border = 'none';
  stopwatchBtn.style.padding = '8px 12px';
  stopwatchBtn.style.borderRadius = '4px';
  stopwatchBtn.style.cursor = 'pointer';

  logSection.appendChild(stopwatchDisplay);
  logSection.appendChild(stopwatchBtn);

  function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  }

  stopwatchBtn.addEventListener('click', async () => {
    const msg = document.getElementById('logMessage');
    msg.textContent = '';

    if (!stopwatchInterval) {
      startTime = Date.now();
      stopwatchBtn.textContent = 'Stop Stopwatch';
      stopwatchInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        stopwatchDisplay.textContent = '‚è± ' + formatTime(elapsed);
      }, 1000);
    } else {
      clearInterval(stopwatchInterval);
      stopwatchInterval = null;
      stopwatchBtn.textContent = 'Start Stopwatch';

      const elapsedMs = Date.now() - startTime;
      const elapsedMinutes = Math.round(elapsedMs / 60000);

      if (elapsedMinutes < 1) {
        msg.textContent = 'Session too short to log (<1 minute).';
        return;
      }

      if (confirm(`You read for about ${elapsedMinutes} minute(s). Log this time?`)) {
        await logMinutesToHistory(elapsedMinutes);
      }
    }
  });

  loadDashboard();
</script>


</body>
</html>





















