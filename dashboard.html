<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Library Reading Challenge</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 20px;
      background-color: #f5f5f5;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #ccc;
    }

    .profile {
      position: relative;
      width: 40px;
      height: 40px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      z-index: 10;
    }

    .dropdown button {
      width: 100%;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      text-align: left;
    }

    .dropdown button:hover {
      background-color: #f0f0f0;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .leaderboard-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .leaderboard-bar span {
      display: inline-block;
      height: 30px;
      line-height: 30px;
      color: white;
      padding-left: 10px;
      border-radius: 4px;
    }

    .leaderboard-profile {
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      font-weight: bold;
      color: white;
      border-radius: 50%;
      background-color: #007bff;
      flex-shrink: 0;
    }

    .leaderboard-label {
      margin-left: 10px;
      font-weight: bold;
    }

    /* ðŸŒˆ Community progress bar */
    .progress-container {
      position: relative;
      width: 100%;
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 15px;
      overflow: visible;
      margin-top: 10px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #007bff, #00bfff);
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 15px 0 0 15px;
    }

    .milestone {
      position: absolute;
      top: -8px;
      width: 2px;
      height: 46px;
      background: #555;
      z-index: 2
    }

    .milestone-label {
  position: absolute;
  bottom: 100%; /* ðŸ‘ˆ anchors the label above the bar */
  margin-bottom: 6px; /* space between label and bar */
  top: -26px;
  left: 0;
  font-size: clamp(9px, 1.2vw, 11px); /* responsive text size */
  color: #333;
  transform: translateX(-50%);
  white-space: nowrap;
  font-weight: 500;
  z-index: 3;
}

    #communitySection h3 { margin-bottom: 20px; }

    .progress-text {
      margin-top: 10px;
      font-weight: bold;
    }

    input[type="number"] {
      width: 80px;
      margin-right: 10px;
    }

    button.submit-minutes {
      background-color: #28a745;
      color: white;
    }

    button.submit-minutes:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

<header>
  <h1>Library Reading Challenge</h1>
  <div class="profile" id="profileIcon">
    <span id="profileInitial">U</span>
    <div class="dropdown" id="profileDropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<div class="section" id="welcomeSection">
  <h2 id="welcomeMessage">Welcome back!</h2>
</div>

<div class="section" id="leaderboardSection">
  <h3>Top 10 Leaderboard</h3>
  <div id="leaderboardContainer"></div>
</div>

<!-- ðŸŒ COMMUNITY PROGRESS BAR -->
<div class="section" id="communitySection">
  <h3>Community Progress</h3>
  <div class="progress-container" id="communityProgressBar">
    <div class="progress-bar" id="progressFill"></div>
  </div>
  <div id="progressText" class="progress-text"></div>
</div>

<div class="section" id="userMinutesSection">
  <h3>Your Logged Minutes</h3>
  <p id="userMinutes"></p>
</div>

<div class="section" id="logMinutesSection">
  <h3>Log More Minutes</h3>
  <input type="text" id="bookTitleInput" placeholder="Book Title" style="margin-right:10px;">
  <input type="number" id="minutesInput" placeholder="Minutes" min="1" max="120">
  <button class="submit-minutes" id="logMinutesBtn">Log Minutes</button>
  <p id="logMessage" style="color:red;"></p>
</div>

<script>
  const SUPABASE_URL = 'https://hfugnpqguidgosxyuioj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmdWducHFndWlkZ29zeHl1aW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NjE3ODAsImV4cCI6MjA3ODAzNzc4MH0.eawP-KaZTXOAE_OSYeJR6Ds_c6aKsqOsXo_EGifgtrU';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const COMMUNITY_GOAL = 1000000;
  let currentUser = null;
  let userTotalMinutes = 0;

  async function loadDashboard() {
    const username = sessionStorage.getItem('username');
    if (!username) {
      window.location.href = 'login.html';
      return;
    }

    // Fetch user data
    const { data: userData, error: userError } = await supabase
      .from('Userdetails')
      .select('*')
      .eq('user_name', username)
      .single();

    if (userError) return alert('Error loading user data: ' + userError.message);
    currentUser = userData;

    // Fetch logs for user
    const { data: logs } = await supabase
      .from('loghistory')
      .select('minutes_logged')
      .eq('user_name', currentUser.user_name);

    userTotalMinutes = logs?.reduce((sum, e) => sum + e.minutes_logged, 0) || 0;

    await supabase
      .from('Userdetails')
      .update({ minutes_logged: userTotalMinutes })
      .eq('user_name', currentUser.user_name);

    document.getElementById('profileInitial').textContent = currentUser.user_name[0].toUpperCase();
    document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.user_name}!`;
    document.getElementById('userMinutes').textContent = `${userTotalMinutes} minutes`;

    // Leaderboard
    const { data: allUsers } = await supabase
      .from('Userdetails')
      .select('user_name, minutes_logged');

    const top10 = allUsers
      .filter(u => u.minutes_logged && u.minutes_logged > 0)
      .sort((a, b) => b.minutes_logged - a.minutes_logged)
      .slice(0, 10);

    const container = document.getElementById('leaderboardContainer');
    container.innerHTML = '';
    if (top10.length === 0) container.textContent = 'No leaderboard data available.';
    else {
      top10.forEach(user => {
        const barWrapper = document.createElement('div');
        barWrapper.classList.add('leaderboard-bar');
        const profileDiv = document.createElement('div');
        profileDiv.classList.add('leaderboard-profile');
        profileDiv.textContent = user.user_name[0].toUpperCase();
        const barSpan = document.createElement('span');
        barSpan.style.width = Math.min(user.minutes_logged / 10, 300) + 'px';
        barSpan.style.backgroundColor = '#007bff';
        const label = document.createElement('div');
        label.classList.add('leaderboard-label');
        label.textContent = `${user.user_name}: ${user.minutes_logged} min`;
        barWrapper.append(profileDiv, barSpan, label);
        container.appendChild(barWrapper);
      });
    }

    // ðŸŒ Community total
    const { data: allLogs } = await supabase.from('loghistory').select('minutes_logged');
    const totalMinutes = allLogs?.reduce((s, l) => s + l.minutes_logged, 0) || 0;
    updateProgressBar(totalMinutes);
  }

   function updateProgressBar(totalMinutes) {
    const fill = document.getElementById('progressFill');
    const text = document.getElementById('progressText');
    const container = document.getElementById('communityProgressBar');
    const percent = Math.min((totalMinutes / COMMUNITY_GOAL) * 100, 100);
    fill.style.width = percent + '%';
    text.textContent = `Community has logged ${totalMinutes.toLocaleString()} of ${COMMUNITY_GOAL.toLocaleString()} minutes (${percent.toFixed(2)}%)`;

    // Clear previous markers
    container.querySelectorAll('.milestone, .milestone-label').forEach(el => el.remove());

    // Define milestone markers
    const milestones = [10000, 50000, 100000];
    for (let i = 200000; i <= COMMUNITY_GOAL; i += 100000) milestones.push(i);

    // Build markers dynamically
    milestones.forEach(ms => {
      const pos = (ms / COMMUNITY_GOAL) * container.offsetWidth;
      const line = document.createElement('div');
      line.classList.add('milestone');
      line.style.left = `${pos}px`;

      const label = document.createElement('div');
      label.classList.add('milestone-label');
      label.style.left = `${pos}px`;
      label.textContent = ms >= 1000000 ? '1M' : (ms >= 1000 ? (ms / 1000) + 'k' : ms);

      container.append(line, label);
    });
  }

  // ðŸ“¦ Event listeners

  window.addEventListener('resize', async () => {
    const { data: allLogs } = await supabase.from('loghistory').select('minutes_logged');
    const totalMinutes = allLogs?.reduce((s, l) => s + l.minutes_logged, 0) || 0;
    updateProgressBar(totalMinutes);
  });

  document.getElementById('profileIcon').addEventListener('click', () => {
    const dropdown = document.getElementById('profileDropdown');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  });

  document.addEventListener('click', e => {
    if (!document.getElementById('profileIcon').contains(e.target))
      document.getElementById('profileDropdown').style.display = 'none';
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    sessionStorage.removeItem('username');
    window.location.href = 'login.html';
  });

  async function logMinutesToHistory(minutes, bookTitle) {
    const { error } = await supabase
      .from('loghistory')
      .insert([{ user_name: currentUser.user_name, minutes_logged: minutes, book_title: bookTitle, time_logged: new Date().toISOString() }]);
    if (error) alert('Error logging minutes: ' + error.message);
    else await loadDashboard();
  }

  document.getElementById('logMinutesBtn').addEventListener('click', async () => {
    const minutes = parseInt(document.getElementById('minutesInput').value);
    const bookTitle = document.getElementById('bookTitleInput').value;
    const msg = document.getElementById('logMessage');
    msg.textContent = '';
    if (!bookTitle.trim()) return msg.textContent = 'Please enter the book title.';
    if (isNaN(minutes) || minutes < 1 || minutes > 120)
      return msg.textContent = 'Please enter a valid number of minutes (1â€“120).';
    await logMinutesToHistory(minutes, bookTitle);
    document.getElementById('minutesInput').value = '';
    document.getElementById('bookTitleInput').value = '';
  });

  loadDashboard();
</script>

</body>
</html>




