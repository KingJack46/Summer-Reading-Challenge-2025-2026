<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Library Reading Challenge</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 20px;
      background-color: #f5f5f5;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid #ccc;
    }

    .profile {
      position: relative;
      width: 40px;
      height: 40px;
      background-color: #007bff;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      cursor: pointer;
    }

    .dropdown {
      display: none;
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      overflow: hidden;
      z-index: 10;
    }

    .dropdown button {
      width: 100%;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      text-align: left;
    }

    .dropdown button:hover {
      background-color: #f0f0f0;
    }

    .section {
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .leaderboard-bar {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .leaderboard-bar span {
      display: inline-block;
      height: 30px;
      line-height: 30px;
      color: white;
      padding-left: 10px;
      border-radius: 4px;
    }

    .leaderboard-profile {
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-right: 10px;
      font-weight: bold;
      color: white;
      border-radius: 50%;
      background-color: #007bff;
      flex-shrink: 0;
    }

    .leaderboard-label {
      margin-left: 10px;
      font-weight: bold;
    }

    input[type="number"] {
      width: 80px;
      margin-right: 10px;
    }

    button.submit-minutes {
      background-color: #28a745;
      color: white;
    }

    button.submit-minutes:hover {
      background-color: #218838;
    }
  </style>
</head>
<body>

<header>
  <h1>Library Reading Challenge</h1>
  <div class="profile" id="profileIcon">U
    <div class="dropdown" id="profileDropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<div class="section" id="welcomeSection">
  <h2 id="welcomeMessage">Welcome back!</h2>
</div>

<div class="section" id="leaderboardSection">
  <h3>Top 10 Leaderboard</h3>
  <div id="leaderboardContainer"></div>
</div>

<div class="section" id="communitySection">
  <h3>Community Progress</h3>
  <p id="communityProgress"></p>
</div>

<div class="section" id="userMinutesSection">
  <h3>Your Logged Minutes</h3>
  <p id="userMinutes"></p>
</div>

<div class="section" id="logMinutesSection">
  <h3>Log More Minutes</h3>
  <input type="number" id="minutesInput" placeholder="Minutes" min="1" max="120">
  <button class="submit-minutes" id="logMinutesBtn">Log Minutes</button>
  <p id="logMessage" style="color:red;"></p>
</div>

<script>
  // ðŸš¨ Supabase config
  const SUPABASE_URL = 'https://hfugnpqguidgosxyuioj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmdWducHFndWlkZ29zeHl1aW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NjE3ODAsImV4cCI6MjA3ODAzNzc4MH0.eawP-KaZTXOAE_OSYeJR6Ds_c6aKsqOsXo_EGifgtrU'; // Replace with your anon key
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Dynamic community goal
  const COMMUNITY_GOAL = 1000000;

  let currentUser = null;

  async function loadDashboard() {
    // fetch current user session
    const username = sessionStorage.getItem('username');
    if (!username) {
      window.location.href = 'login.html';
      return;
    }

    // Fetch current user data
    const { data: userData, error: userError } = await supabase
      .from('Userdetails')
      .select('*')
      .eq('user_name', username)
      .single();

    if (userError) {
      alert('Error loading user data: ' + userError.message);
      return;
    }

    currentUser = userData;

    // Profile icon
    document.getElementById('profileIcon').textContent = currentUser.user_name[0].toUpperCase();

    // Welcome message
    document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.user_name}!`;

    // User minutes
    document.getElementById('userMinutes').textContent = `${currentUser.minutes_logged} minutes`;

    // Leaderboard
    const { data: leaderboardData } = await supabase
      .from('Userdetails')
      .select('user_name, minutes_logged')
      .order('minutes_logged', { ascending: false })
      .limit(10);

    const container = document.getElementById('leaderboardContainer');
    container.innerHTML = '';

    leaderboardData.forEach(user => {
      const barLength = Math.min(user.minutes_logged / 10, 300); // scale for display

      const barWrapper = document.createElement('div');
      barWrapper.classList.add('leaderboard-bar');

      const profileDiv = document.createElement('div');
      profileDiv.classList.add('leaderboard-profile');
      profileDiv.textContent = user.user_name[0].toUpperCase();

      const barSpan = document.createElement('span');
      barSpan.style.width = barLength + 'px';
      barSpan.textContent = '';
      barSpan.style.backgroundColor = '#007bff';

      const minutesLabel = document.createElement('div');
      minutesLabel.classList.add('leaderboard-label');
      minutesLabel.textContent = user.minutes_logged;

      barWrapper.appendChild(profileDiv);
      barWrapper.appendChild(barSpan);
      barWrapper.appendChild(minutesLabel);

      container.appendChild(barWrapper);
    });

    // Community total
    const { data: allData } = await supabase
      .from('Userdetails')
      .select('minutes_logged');

    const totalMinutes = allData.reduce((sum, u) => sum + u.minutes_logged, 0);
    document.getElementById('communityProgress').textContent =
      `Community has logged ${totalMinutes} of ${COMMUNITY_GOAL} minutes (${((totalMinutes/COMMUNITY_GOAL)*100).toFixed(2)}%)`;
  }

  // Profile dropdown toggle
  const profileIcon = document.getElementById('profileIcon');
  const dropdown = document.getElementById('profileDropdown');
  profileIcon.addEventListener('click', () => {
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    sessionStorage.removeItem('username');
    window.location.href = 'login.html';
  });

  // Log minutes
document.getElementById('logMinutesBtn').addEventListener('click', async () => {
  const minutes = parseInt(document.getElementById('minutesInput').value);
  const msg = document.getElementById('logMessage');
  msg.textContent = '';

  if (isNaN(minutes) || minutes < 1 || minutes > 120) {
    msg.textContent = 'Please enter a valid number of minutes (1-120).';
    return;
  }

  // Update DB first
  console.log(currentUser.user_name);
  const response = await supabase
  .from('Userdetails')
  .update({ minutes_logged: currentUser.minutes_logged + minutes })
  .eq('user_name', currentUser.user_name)
  .select(); // no .single()
  .single();
  console.log(currentUser.id);
  console.log('Full response:', response);

  /*
  const { data: updatedUser, error } = await supabase
    .from('Userdetails')
    .update({ minutes_logged: currentUser.minutes_logged + minutes })
    .eq('id', currentUser.id)
    .select() // <-- ensures we get the updated record back
    .single();

  if (error) {
    msg.textContent = 'Error logging minutes: ' + error.message;
    return;
  }

  // Update local state
  currentUser = updatedUser;
  document.getElementById('userMinutes').textContent = `${currentUser.minutes_logged} minutes`;

  // Reset input
  document.getElementById('minutesInput').value = '';
  */
  // Reload leaderboard & community progress (no need to refetch current user)
  await loadDashboard();
});

  // Run on page load
  loadDashboard();
</script>

</body>
</html>










