<script>
const SUPABASE_URL = 'https://hfugnpqguidgosxyuioj.supabase.co';
const SUPABASE_ANON_KEY = ''eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhmdWducHFndWlkZ29zeHl1aW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NjE3ODAsImV4cCI6MjA3ODAzNzc4MH0.eawP-KaZTXOAE_OSYeJR6Ds_c6aKsqOsXo_EGifgtrU';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

document.getElementById('signupForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const user_name = document.getElementById('user_name').value.trim();
  const password = document.getElementById('password').value.trim();

  let emailInput = document.getElementById('email_address').value.trim();  // ⭐ plaintext email
  const phone = document.getElementById('phone_number').value.trim() || null;
  const message = document.getElementById('message');

  if (!emailInput && !phone) {
    message.textContent = "You must provide a username (email field) or phone number.";
    return;
  }

  // ⭐ Create faux email for Supabase
  let supabaseEmail = emailInput ? `${emailInput}@gmail.com` : null;

  message.textContent = "Checking username availability...";

  // Check username availability
  const { data: takenUsernames, error: takenError } = await supabase
    .from('Userdetails')
    .select('user_name')
    .eq('user_name', user_name);

  if (takenError) {
    message.textContent = "Error checking username availability.";
    return;
  }

  if (takenUsernames.length > 0) {
    message.textContent = "Username is already taken.";
    return;
  }

  message.textContent = "Creating account...";

  // ⭐ Use faux @gmail.com email for Supabase Auth
  const { data, error: signupError } = await supabase.auth.signUp({
    email: supabaseEmail,    // ⭐ fake email used ONLY for auth
    phone,
    password,
  });

  if (signupError) {
    message.textContent = "Signup error: " + signupError.message;
    return;
  }

  const userId = data.user.id;

  // ⭐ Save ONLY plaintext (no @gmail.com) into your table
  const { error: insertError } = await supabase.from('Userdetails').insert([{
    id: userId,
    user_name: user_name,
    email: emailInput,          // ⭐ STORE PLAINTEXT VERSION IF DESIRED
    minutes_logged: 0,
    reading_streak: 0
  }]);

  if (insertError) {
    message.textContent = "Error saving user details: " + insertError.message;
    return;
  }

  message.textContent = "Signup successful! Your account has been created.";

  setTimeout(() => {
    window.location.href = "login.html";
  }, 1500);
});
</script>

